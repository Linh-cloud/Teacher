{% extends "base.html" %}
{% block title %}Ki·ªÉm tra th·ªùi kh√≥a bi·ªÉu gi√°o vi√™n{% endblock %}

{% block content %}
<div class="d-flex align-items-start gap-3 flex-wrap">

  <!-- Sidebar r√†ng bu·ªôc -->
  <aside class="constraint-sidebar">
    <div class="constraint-title">TKB CH√çNH KHOA</div>
    <ul class="constraint-list">
      <li>
        <label>
          <input type="checkbox" id="rb_max_period_per_session" checked>
          12. S·ªë ti·∫øt t·ªëi ƒëa trong bu·ªïi c·ªßa m√¥n
        </label>
      </li>
      <!-- C√≥ th·ªÉ b·ªï sung r√†ng bu·ªôc kh√°c -->
    </ul>
  </aside>

  <main class="flex-grow-1">

    <!-- M·∫´u v√≠ d·ª• -->
    <div class="mb-3">
      <button type="button" class="btn btn-info btn-sm" id="btnToggleSample">
        üëÅ Xem m·∫´u v√≠ d·ª• ƒë·∫ßu v√†o
      </button>
      <div id="mau_tkb_img" class="mt-2 d-none text-center">
        <img src="{{ url_for('static', filename='sample.png') }}"
             alt="M·∫´u v√≠ d·ª• ƒë·∫ßu v√†o"
             style="max-width:100%;border:1px solid #bbb;box-shadow:0 2px 8px #eaeaea;padding:4px; background:#fff;">
        <div class="mt-2">
          <button type="button" class="btn btn-secondary btn-sm" id="btnHideSample">ƒê√≥ng m·∫´u</button>
        </div>
      </div>
    </div>

    <h2 class="text-center mb-3">Ki·ªÉm tra th·ªùi kh√≥a bi·ªÉu gi√°o vi√™n</h2>

    <form id="tkbForm" method="POST" enctype="multipart/form-data" class="mb-3">
      <div class="row gy-2 align-items-center justify-content-center">

        <!-- File input -->
        <div class="col-12 col-md-5 col-lg-4">
          <input class="form-control" type="file" name="tkb_file" accept=".xlsx" id="tkb_file_input">
        </div>

        <!-- Zoom controls -->
        <div class="col-12 col-md-7 col-lg-6">
          <div class="zoom-slider-group">
            <button type="button" class="zoom-btn" id="zoomMinus" aria-label="Gi·∫£m zoom">‚àí</button>
            <input id="zoom_range" name="zoom_range" type="range" min="0.3" max="2" step="0.01"
                   value="{{ zoom|default(1) }}" class="zoom-range" aria-label="Ph√≥ng to/thu nh·ªè">
            <button type="button" class="zoom-btn" id="zoomPlus" aria-label="TƒÉng zoom">+</button>
            <span id="zoom_percent" class="ms-1" style="min-width: 36px; display:inline-block; text-align:right;">
              {{ (zoom*100)|round(0) if zoom else 100 }}
            </span> %
            <input type="hidden" id="zoom" name="zoom" value="{{ zoom|default(1) }}">
          </div>
        </div>

        <!-- Actions -->
        <div class="col-12 col-lg-10 d-flex flex-wrap gap-2 justify-content-center">
          <div class="btn-group" role="group" aria-label="Ho√†n t√°c/l√†m l·∫°i">
            <button type="button" class="btn btn-outline-secondary" id="btnUndo">Tr∆∞·ªõc ƒë√≥</button>
            <button type="button" class="btn btn-outline-secondary" id="btnRedo">Sau ƒë√≥</button>
          </div>
          <button class="btn btn-success" type="submit" name="action" value="save_edit">L∆∞u ch·ªânh s·ª≠a</button>
          <a href="{{ url_for('teacher_off') }}" class="btn btn-info">Th·ªëng k√™ ng√†y ngh·ªâ GV</a>
          <span id="autosave-status" class="align-self-center text-success fw-medium"></span>
        </div>
      </div>

      <div class="mt-3 text-center">
        <label for="min_period_input" class="fw-semibold me-2">S·ªë ti·∫øt t·ªëi thi·ªÉu m·ªói ng√†y/l·ªõp:</label>
        <input id="min_period_input" type="number" min="1" max="10" value="2" style="width:64px; text-align:right;">
      </div>

      {% if headers %}
      <h5 class="text-center mt-4">B·∫£ng th·ªùi kh√≥a bi·ªÉu (cho ph√©p ch·ªânh s·ª≠a):</h5>

      <!-- B√°o c√°o/vi ph·∫°m -->
      <div id="duplicateTableContainer" class="mt-3"></div>
      <div id="minPeriodDayContainer" class="mt-3"></div>
      <div id="consecutivePeriodsContainer" class="mt-3"></div>

      <!-- B·∫£ng TKB -->
      <div class="table-container mt-2">
        <div class="zoom-box" style="transform: scale({{ zoom|default(1) }});">
          <table class="big-table" id="tkbTable" data-col-offset="2">
            <thead>
              <tr>
                <th rowspan="2" class="header-small">Th·ª©</th>
                <th rowspan="2" class="header-tiet">Ti·∫øt</th>
                {% for label in class_labels %}
                  <th colspan="2" class="header-class">{{ label }}</th>
                {% endfor %}
              </tr>
              <tr>
                {% for _ in class_labels %}
                  <th class="header-mon">M√¥n</th>
                  <th class="header-gv">GV d·∫°y</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row_idx, row in enumerate(tkb_data) %}
                <tr>
                  {% for col_idx, cell in enumerate(row) %}
                    <td>
                      <input type="text"
                             name="cell_{{row_idx}}_{{col_idx}}"
                             value="{{ cell }}"
                             class="big-input"
                             autocomplete="off"
                             inputmode="text" />
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </form>

  </main>
</div>
{% endblock %}

{% block extra_script %}
<script>
/* ========= Helpers ========= */
const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
function debounce(fn, wait=150){
  let t; return (...args) => { clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
}

/* ========= Sample toggle ========= */
(() => {
  const btnShow = $('#btnToggleSample');
  const btnHide = $('#btnHideSample');
  const box = $('#mau_tkb_img');
  if (btnShow && box) btnShow.addEventListener('click', ()=> box.classList.toggle('d-none'));
  if (btnHide && box) btnHide.addEventListener('click', ()=> box.classList.add('d-none'));
})();

/* ========= Auto-submit when choose file ========= */
(() => {
  const fileInput = $('#tkb_file_input');
  const form = $('#tkbForm');
  if (fileInput && form) {
    fileInput.addEventListener('change', () => {
      if (fileInput.files && fileInput.files.length) form.submit();
    });
  }
})();

/* ========= Zoom controls ========= */
(() => {
  const range = $('#zoom_range');
  const percent = $('#zoom_percent');
  const hiddenZoom = $('#zoom');
  const btnMinus = $('#zoomMinus');
  const btnPlus = $('#zoomPlus');

  function apply(val){
    const v = parseFloat(val) || 1;
    if (percent) percent.textContent = Math.round(v*100);
    if (hiddenZoom) hiddenZoom.value = v;
    // H√†m helper c√≥ trong base.html (applyZoom) ho·∫∑c fallback
    if (window.applyZoom) window.applyZoom(v);
    else { const box = $('.zoom-box'); if (box) box.style.transform = `scale(${v})`; }
  }
  if (range) {
    range.addEventListener('input', e => apply(e.target.value));
    apply(range.value);
  }
  if (btnMinus) btnMinus.addEventListener('click', () => {
    if (!range) return;
    const v = clamp(parseFloat(range.value||"1") - 0.05, 0.3, 2);
    range.value = v.toFixed(2); apply(v);
  });
  if (btnPlus) btnPlus.addEventListener('click', () => {
    if (!range) return;
    const v = clamp(parseFloat(range.value||"1") + 0.05, 0.3, 2);
    range.value = v.toFixed(2); apply(v);
  });
})();

/* ========= Undo/Redo + Autosave ========= */
const undoStack = [];
let   redoStack = [];
const autosaveStatus = $('#autosave-status');

function getCurrentData(){
  const data = [];
  $$('#tkbTable tbody tr').forEach(tr=>{
    const row=[];
    $$('input[type="text"]', tr).forEach(inp=>row.push(inp.value));
    data.push(row);
  });
  return data;
}

function putData(data){
  $$('#tkbTable tbody tr').forEach((tr,i)=>{
    $$('input[type="text"]', tr).forEach((inp,j)=>{
      if (data[i] && typeof data[i][j] !== 'undefined') inp.value = data[i][j];
    });
  });
}

function markSaved(text="ƒê√£ l∆∞u t·∫°m"){
  if (autosaveStatus){ autosaveStatus.textContent = text; }
}

const saveState = debounce(()=>{
  const data = getCurrentData();
  undoStack.push(JSON.stringify(data));
  if (undoStack.length > 50) undoStack.shift();
  redoStack = [];
  localStorage.setItem("tkb_autosave", JSON.stringify(data));
  markSaved("ƒê√£ l∆∞u t·∫°m");
  renderAllReports();
}, 200);

function initAutosave(){
  // seed state
  undoStack.length = 0;
  redoStack = [];
  undoStack.push(JSON.stringify(getCurrentData()));

  // input listeners
  $$('#tkbTable input[type="text"]').forEach(inp=>{
    inp.addEventListener('input', saveState);
  });

  // restore draft if present
  const draft = localStorage.getItem("tkb_autosave");
  if (draft && confirm("B·∫°n c√≥ mu·ªën kh√¥i ph·ª•c d·ªØ li·ªáu ch∆∞a l∆∞u kh√¥ng?")){
    try {
      const arr = JSON.parse(draft);
      putData(arr);
      markSaved("ƒê√£ kh√¥i ph·ª•c d·ªØ li·ªáu t·∫°m!");
    } catch(_) {}
  }
}

$('#btnUndo')?.addEventListener('click', ()=>{
  if (undoStack.length > 1){
    const current = undoStack.pop();
    redoStack.push(current);
    const prev = JSON.parse(undoStack[undoStack.length-1]);
    putData(prev);
    markSaved("Ho√†n t√°c th√†nh c√¥ng");
    renderAllReports();
  }
});

$('#btnRedo')?.addEventListener('click', ()=>{
  if (redoStack.length){
    const next = JSON.parse(redoStack.pop());
    undoStack.push(JSON.stringify(next));
    putData(next);
    markSaved("ƒê√£ redo");
    renderAllReports();
  }
});

/* ========= Reports: Duplicate GV / Min periods / Consecutive ========= */

function getHeadersAndOffsets(){
  // colOffset = 2 (Th·ª©, Ti·∫øt)
  const colOffset = parseInt($('#tkbTable')?.dataset?.colOffset || '2', 10);
  const headRows = $$('#tkbTable thead tr');
  if (headRows.length < 2) return { colOffset, classLabels: [], gvCols: [], monCols: [] };

  // L·∫•y nh√£n l·ªõp t·ª´ h√†ng 1 (row 0) c√≥ colspan=2
  const classLabels = [];
  $$('th', headRows[0]).forEach((th, idx)=>{
    if (idx >= colOffset && (th.colSpan === 2)) classLabels.push((th.textContent||'').trim());
  });

  // ·ªû h√†ng 2: x√°c ƒë·ªãnh c·ªôt M√¥n/GV theo text
  const monCols = [], gvCols = [];
  const ths2 = $$('th', headRows[1]);
  ths2.forEach((th, i)=>{
    const txt = (th.textContent||'').toLowerCase();
    const absIdx = colOffset + i;
    if (txt.includes('gv')) gvCols.push(absIdx);
    else monCols.push(absIdx);
  });

  return { colOffset, classLabels, gvCols, monCols };
}

function renderDuplicateTable(){
  const table = $('#tkbTable');
  const tbody = table?.tBodies?.[0];
  if (!tbody) return;

  const { gvCols } = getHeadersAndOffsets();
  const results = [];

  // clear old highlight
  $$('input', tbody).forEach(inp=>{
    inp.classList.remove('dup-cell');
    inp.parentElement?.classList.remove('dup-cell');
  });

  Array.from(tbody.rows).forEach((tr)=>{
    const thu = tr.cells[0]?.querySelector('input')?.value || tr.cells[0]?.innerText.trim();
    const tiet = tr.cells[1]?.querySelector('input')?.value || tr.cells[1]?.innerText.trim();

    const seen = {};
    gvCols.forEach(col=>{
      const inp = tr.cells[col]?.querySelector('input');
      const val = (inp?.value||'').trim();
      if (!val) return;
      (seen[val] ||= []).push(inp);
    });

    Object.entries(seen).forEach(([gv, arr])=>{
      if (arr.length > 1){
        arr.forEach(inp=>{
          inp.classList.add('dup-cell');
          inp.parentElement?.classList.add('dup-cell');
        });
        results.push({ gv, thu, tiet, so_lan_trung: arr.length });
      }
    });
  });

  const el = $('#duplicateTableContainer');
  if (!el) return;
  el.innerHTML = results.length
    ? `<table class="table table-bordered mb-3">
         <thead class="table-danger">
           <tr><th>Gi√°o vi√™n</th><th>Th·ª©</th><th>Ti·∫øt</th><th>S·ªë l·∫ßn tr√πng</th></tr>
         </thead>
         <tbody>
           ${results.map(r=>`
             <tr class="table-danger">
               <td>${r.gv}</td><td>${r.thu}</td><td>${r.tiet}</td><td>${r.so_lan_trung}</td>
             </tr>`).join('')}
         </tbody>
       </table>`
    : `<div class="alert alert-success mb-3">Kh√¥ng c√≥ gi√°o vi√™n n√†o b·ªã tr√πng ti·∫øt!</div>`;
}

function renderMinPeriodPerDayTable(minPeriods){
  const table = $('#tkbTable');
  const tbody = table?.tBodies?.[0];
  if (!tbody) return;

  const { colOffset, classLabels, monCols } = getHeadersAndOffsets();
  const dayTiet = {}; // label -> thu -> [tiet]

  Array.from(tbody.rows).forEach((tr)=>{
    const thu  = tr.cells[0]?.querySelector('input')?.value || tr.cells[0]?.innerText.trim();
    const tiet = parseInt(tr.cells[1]?.querySelector('input')?.value || tr.cells[1]?.innerText.trim(), 10);

    monCols.forEach((absIdx, i)=>{
      const label = classLabels[i];
      const val   = tr.cells[absIdx]?.querySelector('input')?.value || "";
      if (label && val.trim()){
        (dayTiet[label] ||= {});
        (dayTiet[label][thu] ||= []).push(tiet);
      }
    });
  });

  const rows = [];
  for (const label of classLabels){
    const days = dayTiet[label] || {};
    for (const thu in days){
      const arr = (days[thu]||[]).slice().sort((a,b)=>a-b);
      if (arr.length < minPeriods){
        rows.push({ label, thu, count: arr.length, req: minPeriods, periods: arr.join(', ') });
      }
    }
  }

  $('#minPeriodDayContainer').innerHTML = rows.length
    ? `<table class="table table-bordered mb-3">
         <thead class="table-warning">
          <tr><th>L·ªõp</th><th>Th·ª©</th><th>S·ªë ti·∫øt th·ª±c t·∫ø</th><th>Y√™u c·∫ßu t·ªëi thi·ªÉu</th><th>C√°c ti·∫øt</th></tr>
         </thead>
         <tbody>
           ${rows.map(r=>`
             <tr class="table-warning">
               <td>${r.label}</td><td>${r.thu}</td><td>${r.count}</td><td>${r.req}</td><td>${r.periods}</td>
             </tr>`).join('')}
         </tbody>
       </table>`
    : `<div class="alert alert-success mb-3">T·∫•t c·∫£ c√°c l·ªõp ƒë·ªÅu c√≥ s·ªë ti·∫øt t·ªëi thi·ªÉu h·ª£p l·ªá trong m·ªói ng√†y!</div>`;
}

function renderConsecutivePeriodsTable(){
  const table = $('#tkbTable');
  const tbody = table?.tBodies?.[0];
  if (!tbody) return;

  const { classLabels, monCols } = getHeadersAndOffsets();
  const dayTiet = {}; // label -> thu -> [tiet]

  Array.from(tbody.rows).forEach((tr)=>{
    const thu  = tr.cells[0]?.querySelector('input')?.value || tr.cells[0]?.innerText.trim();
    const tiet = parseInt(tr.cells[1]?.querySelector('input')?.value || tr.cells[1]?.innerText.trim(), 10);

    monCols.forEach((absIdx, i)=>{
      const label = classLabels[i];
      const val   = tr.cells[absIdx]?.querySelector('input')?.value || "";
      if (label && val.trim()){
        (dayTiet[label] ||= {});
        (dayTiet[label][thu] ||= []).push(tiet);
      }
    });
  });

  const rows = [];
  for (const label of classLabels){
    const days = dayTiet[label] || {};
    for (const thu in days){
      const arr = (days[thu]||[]).slice().sort((a,b)=>a-b);
      if (arr.length <= 1) continue;
      let consecutive = true;
      for (let i=1;i<arr.length;i++){
        if (arr[i] - arr[i-1] !== 1){ consecutive = false; break; }
      }
      if (!consecutive){
        rows.push({ label, thu, periods: arr.join(', '), note: 'C√°c ti·∫øt kh√¥ng li·ªÅn nhau (x√© l·∫ª)!' });
      }
    }
  }

  $('#consecutivePeriodsContainer').innerHTML = rows.length
    ? `<table class="table table-bordered mb-3">
         <thead class="table-warning">
          <tr><th>L·ªõp</th><th>Th·ª©</th><th>C√°c ti·∫øt</th><th>Th√¥ng b√°o</th></tr>
         </thead>
         <tbody>
           ${rows.map(r=>`
             <tr class="table-warning">
               <td>${r.label}</td><td>${r.thu}</td><td>${r.periods}</td><td>${r.note}</td>
             </tr>`).join('')}
         </tbody>
       </table>`
    : `<div class="alert alert-success mb-3">Kh√¥ng c√≥ l·ªõp n√†o b·ªã x√© l·∫ª ti·∫øt trong ng√†y!</div>`;
}

function renderAllReports(){
  renderDuplicateTable();
  const minPeriods = parseInt($('#min_period_input')?.value || '2', 10) || 2;
  renderMinPeriodPerDayTable(minPeriods);
  renderConsecutivePeriodsTable();
}

/* ========= Init on load ========= */
window.addEventListener('DOMContentLoaded', ()=>{
  // Zoom init is already handled; set initial outputs
  {% if headers %}
    initAutosave();
    renderAllReports();
    // live update when min_period changes
    $('#min_period_input')?.addEventListener('input', debounce(()=>{
      const v = parseInt($('#min_period_input').value || '2', 10) || 2;
      renderMinPeriodPerDayTable(v);
    }, 120));
  {% endif %}
});
</script>
{% endblock %}
