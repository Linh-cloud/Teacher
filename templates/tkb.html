{% extends 'base.html' %}
{% block title %}X·∫øp Th·ªùi kh√≥a bi·ªÉu{% endblock %}

{% block content %}
<div class="container-xl px-0">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="m-0">Ki·ªÉm tra th·ªùi kh√≥a bi·ªÉu gi√°o vi√™n</h2>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="toggleEdit">
      <label class="form-check-label" for="toggleEdit">Ch·∫ø ƒë·ªô ch·ªânh s·ª≠a</label>
    </div>
  </div>

  <!-- Toggle m·∫´u v√≠ d·ª• -->
  <div class="mb-3">
    <button type="button" class="btn btn-info btn-sm" id="btnToggleSample">üëÅ Xem m·∫´u v√≠ d·ª• ƒë·∫ßu v√†o</button>
    <div id="mau_tkb_img" class="mt-2 d-none text-center">
      <img src="{{ url_for('static', filename='sample.png') }}" alt="M·∫´u v√≠ d·ª• ƒë·∫ßu v√†o"
           style="max-width:100%;border:1px solid #bbb;box-shadow:0 2px 8px #eaeaea;padding:4px;background:#fff;">
      <div class="mt-2">
        <button type="button" class="btn btn-secondary btn-sm" id="btnHideSample">ƒê√≥ng m·∫´u</button>
      </div>
    </div>
  </div>

  <form id="tkbForm" action="{{ url_for('tkb') }}" method="POST" enctype="multipart/form-data" class="mb-3">
    <div class="row gy-2 align-items-center justify-content-center">
      <!-- Ch·ªçn file -->
      <div class="col-12 col-md-5 col-lg-4">
        <input class="form-control" type="file" name="tkb_file" accept=".xlsx" id="tkb_file_input">
      </div>

      <!-- Zoom -->
      <div class="col-12 col-md-7 col-lg-6">
        <div class="zoom-slider-group">
          <button type="button" class="zoom-btn" id="zoomMinus" aria-label="Gi·∫£m zoom">‚àí</button>
          <input id="zoom_range" name="zoom_range" type="range" min="0.3" max="2" step="0.01"
                 value="{{ zoom|default(1) }}" class="zoom-range" aria-label="Ph√≥ng to/thu nh·ªè">
          <button type="button" class="zoom-btn" id="zoomPlus" aria-label="TƒÉng zoom">+</button>
          <span id="zoom_percent" class="ms-1" style="min-width:36px;display:inline-block;text-align:right;">
            {{ (zoom*100)|round(0) if zoom else 100 }}
          </span> %
          <input type="hidden" id="zoom" name="zoom" value="{{ zoom|default(1) }}">
        </div>
      </div>

      <!-- H√†nh ƒë·ªông -->
      <div class="col-12 col-lg-10 d-flex flex-wrap gap-2 justify-content-center">
        <div class="btn-group" role="group" aria-label="Ho√†n t√°c/l√†m l·∫°i">
          <button type="button" class="btn btn-outline-secondary" id="btnUndo">Tr∆∞·ªõc ƒë√≥</button>
          <button type="button" class="btn btn-outline-secondary" id="btnRedo">Sau ƒë√≥</button>
        </div>
        <button class="btn btn-success" type="submit" name="action" value="save_edit">L∆∞u ch·ªânh s·ª≠a</button>
        <a href="{{ url_for('teacher_off') }}" class="btn btn-info">Th·ªëng k√™ ng√†y ngh·ªâ GV</a>
        <span id="autosave-status" class="align-self-center text-success fw-medium"></span>
      </div>
    </div>

    <div class="mt-3 text-center">
      <label for="min_period_input" class="fw-semibold me-2">S·ªë ti·∫øt t·ªëi thi·ªÉu m·ªói ng√†y/l·ªõp:</label>
      <input id="min_period_input" type="number" min="1" max="10" value="2" style="width:64px;text-align:right;">
    </div>

    {% if headers %}
      <h5 class="text-center mt-4">B·∫£ng th·ªùi kh√≥a bi·ªÉu (ch·∫ø ƒë·ªô xem m·∫∑c ƒë·ªãnh):</h5>

      <!-- B√°o c√°o/vi ph·∫°m -->
      <div id="duplicateTableContainer" class="mt-3"></div>
      <div id="minPeriodDayContainer" class="mt-3"></div>
      <div id="consecutivePeriodsContainer" class="mt-3"></div>

      <!-- B·∫£ng TKB -->
      <div class="table-container mt-2">
        <div class="zoom-box" style="transform: scale({{ zoom|default(1) }});">
          <table class="big-table" id="tkbTable" data-col-offset="2">
            <thead>
              <tr>
                <th rowspan="2" class="header-small">Th·ª©</th>
                <th rowspan="2" class="header-tiet">Ti·∫øt</th>
                {% for label in class_labels %}
                  <th colspan="2" class="header-class">{{ label }}</th>
                {% endfor %}
              </tr>
              <tr>
                {% for _ in class_labels %}
                  <th class="header-mon">M√¥n</th>
                  <th class="header-gv">GV d·∫°y</th>
                {% endfor %}
              </tr>
            </thead>

            <tbody>
              {# === ∆ØU TI√äN D√ôNG tkb_rows (ƒë√£ g·ªôp Th·ª© b·∫±ng rowspan) === #}
              {% if tkb_rows %}
                {% for r in tkb_rows %}
                <tr>
                  {% if r.show_thu %}
                    <td rowspan="{{ r.rowspan }}">{{ r.thu }}</td>
                  {% endif %}
                  <td>{{ r.tiet }}</td>

                  {# hidden gi·ªØ gi√° tr·ªã ·ªïn ƒë·ªãnh cho JS #}
                  <input type="hidden" class="thu-val" value="{{ r.thu }}">
                  <input type="hidden" class="tiet-val" value="{{ r.tiet }}">

                  {% for cell in r.cells %}
                    <td>
                      <input type="text"
                             name="cell_{{ r.row_idx }}_{{ cell.col_idx }}"
                             value="{{ cell.value }}"
                             class="big-input tkb-cell"
                             data-role="{{ 'mon' if ((cell.col_idx - 2) % 2 == 0) else 'gv' }}"
                             autocomplete="off" inputmode="text" readonly>
                    </td>
                  {% endfor %}
                </tr>
                {% endfor %}

              {# === Fallback: ch∆∞a c√≥ tkb_rows ‚Üí d√πng tkb_data nh∆∞ c≈© === #}
              {% else %}
                {% for row_idx, row in enumerate(tkb_data) %}
                <tr>
                  {# 2 c·ªôt ƒë·∫ßu v·∫´n l√† input ƒë·ªÉ JS ƒë·ªçc/ghi #}
                  <td>
                    <input type="text" name="cell_{{row_idx}}_0" value="{{ row[0] }}" class="big-input" autocomplete="off" inputmode="text" />
                    <input type="hidden" class="thu-val" value="{{ row[0] }}">
                  </td>
                  <td>
                    <input type="text" name="cell_{{row_idx}}_1" value="{{ row[1] }}" class="big-input" autocomplete="off" inputmode="text" />
                    <input type="hidden" class="tiet-val" value="{{ row[1] }}">
                  </td>

                  {% for col_idx in range(2, row|length) %}
                  <td>
                    <input type="text"
                           name="cell_{{row_idx}}_{{col_idx}}"
                           value="{{ row[col_idx] }}"
                           class="big-input tkb-cell"
                           data-role="{{ 'mon' if ((col_idx - 2) % 2 == 0) else 'gv' }}"
                           autocomplete="off" inputmode="text" />
                  </td>
                  {% endfor %}
                </tr>
                {% endfor %}
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}
  </form>
</div>
{% endblock %}

{% block extra_script %}
<script>
/* ========= Helpers ========= */
const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
const debounce = (fn, wait=150) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; };

/* ========= Toggle ·∫£nh m·∫´u ========= */
(() => {
  $('#btnToggleSample')?.addEventListener('click', ()=> $('#mau_tkb_img')?.classList.toggle('d-none'));
  $('#btnHideSample')?.addEventListener('click', ()=> $('#mau_tkb_img')?.classList.add('d-none'));
})();

/* ========= Auto-submit khi ch·ªçn file ========= */
(() => {
  const fileInput = $('#tkb_file_input');
  const form = $('#tkbForm');
  fileInput?.addEventListener('change', ()=>{ if (fileInput.files?.length) form?.submit(); });
})();

/* ========= Zoom ========= */
(() => {
  const range = $('#zoom_range'), percent = $('#zoom_percent'), hiddenZoom = $('#zoom');
  const btnMinus = $('#zoomMinus'), btnPlus = $('#zoomPlus');
  function apply(v){ v=parseFloat(v)||1; percent&&(percent.textContent=Math.round(v*100)); hiddenZoom&&(hiddenZoom.value=v);
    if (window.applyZoom) window.applyZoom(v); else { const box=$('.zoom-box'); if (box) box.style.transform=`scale(${v})`; } }
  range?.addEventListener('input', e=>apply(e.target.value));
  btnMinus?.addEventListener('click', ()=>{ const v=clamp(parseFloat(range?.value||'1')-0.05,0.3,2); if(range)range.value=v.toFixed(2); apply(v); });
  btnPlus?.addEventListener('click', ()=>{ const v=clamp(parseFloat(range?.value||'1')+0.05,0.3,2); if(range)range.value=v.toFixed(2); apply(v); });
  range && apply(range.value);
})();

/* ========= Toggle edit (readonly on/off) ========= */
(() => {
  const apply = (on) => $$('.tkb-cell').forEach(inp => on ? inp.removeAttribute('readonly') : inp.setAttribute('readonly',''));
  apply(false); // m·∫∑c ƒë·ªãnh xem nh∆∞ in
  $('#toggleEdit')?.addEventListener('change', e => apply(e.target.checked));
})();

/* ========= Undo/Redo + Autosave ========= */
const undoStack=[], autosaveStatus=$('#autosave-status'); let redoStack=[];
function getCurrentData(){
  const data=[]; $$('#tkbTable tbody tr').forEach(tr=>{ const row=[];
    $$('input[name^="cell_"]', tr).forEach(inp=>row.push(inp.value)); data.push(row); });
  return data;
}
function putData(data){
  $$('#tkbTable tbody tr').forEach((tr,i)=>{ $$('input[name^="cell_"]', tr).forEach((inp,j)=>{ if(data[i]?.[j]!==undefined) inp.value=data[i][j]; }); });
}
const markSaved=(t="ƒê√£ l∆∞u t·∫°m")=>{ if(autosaveStatus) autosaveStatus.textContent=t; };
const saveState = debounce(()=>{ const data=getCurrentData(); undoStack.push(JSON.stringify(data)); if(undoStack.length>50)undoStack.shift(); redoStack=[];
  localStorage.setItem("tkb_autosave", JSON.stringify(data)); markSaved("ƒê√£ l∆∞u t·∫°m"); renderAllReports(); }, 180);
function initAutosave(){
  undoStack.length=0; redoStack=[]; undoStack.push(JSON.stringify(getCurrentData()));
  $('#tkbTable')?.addEventListener('input', e=>{ if (e.target?.matches('input[type="text"]')) saveState(); });
  const draft=localStorage.getItem("tkb_autosave"); if(draft && confirm("B·∫°n c√≥ mu·ªën kh√¥i ph·ª•c d·ªØ li·ªáu ch∆∞a l∆∞u kh√¥ng?")){ try{ putData(JSON.parse(draft)); markSaved("ƒê√£ kh√¥i ph·ª•c d·ªØ li·ªáu t·∫°m!"); }catch(_){} }
}
$('#btnUndo')?.addEventListener('click', ()=>{ if(undoStack.length>1){ const cur=undoStack.pop(); redoStack.push(cur); const prev=JSON.parse(undoStack.at(-1)); putData(prev); markSaved("Ho√†n t√°c th√†nh c√¥ng"); renderAllReports(); }});
$('#btnRedo')?.addEventListener('click', ()=>{ if(redoStack.length){ const next=JSON.parse(redoStack.pop()); undoStack.push(JSON.stringify(next)); putData(next); markSaved("ƒê√£ redo"); renderAllReports(); }});

/* ========= B√°o c√°o: d√πng data-role & input ·∫©n cho Thu/Tiet ========= */
function getHeaders(){
  const headRows=$$('#tkbTable thead tr'); if(headRows.length<2) return {classLabels:[]};
  const classLabels=[]; $$('th', headRows[0]).forEach((th,idx)=>{ if(idx>=2 && th.colSpan===2) classLabels.push((th.textContent||'').trim()); });
  return { classLabels };
}
function getThuTiet(tr){
  const thu = $('.thu-val', tr)?.value || '';
  const tiet = parseInt($('.tiet-val', tr)?.value || '', 10);
  return { thu, tiet: isNaN(tiet) ? '' : tiet };
}
function renderDuplicateTable(){
  const tbody=$('#tkbTable')?.tBodies?.[0]; if(!tbody) return;
  const results=[]; $$('input.tkb-cell', tbody).forEach(inp=>{ inp.classList.remove('dup-cell'); inp.parentElement?.classList.remove('dup-cell'); });
  Array.from(tbody.rows).forEach(tr=>{
    const { thu, tiet } = getThuTiet(tr);
    const seen={}; $$('input[data-role="gv"]', tr).forEach(inp=>{ const v=inp.value.trim(); if(!v) return; (seen[v]??=[]).push(inp); });
    Object.entries(seen).forEach(([gv,arr])=>{ if(arr.length>1){ arr.forEach(i=>{ i.classList.add('dup-cell'); i.parentElement?.classList.add('dup-cell'); }); results.push({gv,thu,tiet,so_lan_trung:arr.length}); }});
  });
  $('#duplicateTableContainer').innerHTML = results.length
    ? `<table class="table table-bordered mb-3"><thead class="table-danger"><tr><th>Gi√°o vi√™n</th><th>Th·ª©</th><th>Ti·∫øt</th><th>S·ªë l·∫ßn tr√πng</th></tr></thead><tbody>${
        results.map(r=>`<tr class="table-danger"><td>${r.gv}</td><td>${r.thu}</td><td>${r.tiet}</td><td>${r.so_lan_trung}</td></tr>`).join('')
      }</tbody></table>`
    : `<div class="alert alert-success mb-3">Kh√¥ng c√≥ gi√°o vi√™n n√†o b·ªã tr√πng ti·∫øt!</div>`;
}
function renderMinPeriodPerDayTable(minPeriods){
  const tbody=$('#tkbTable')?.tBodies?.[0]; if(!tbody) return;
  const { classLabels } = getHeaders(); const dayTiet={};
  Array.from(tbody.rows).forEach(tr=>{
    const { thu, tiet } = getThuTiet(tr);
    $$('input[data-role="mon"]', tr).forEach((inp,i)=>{ const label=classLabels[i]; if(label && inp.value.trim()){ (dayTiet[label]??={}); (dayTiet[label][thu]??=[]).push(tiet); }});
  });
  const rows=[]; for(const label of classLabels){ const days=dayTiet[label]||{}; for(const thu in days){ const arr=(days[thu]||[]).filter(n=>n!=='' && !isNaN(n)).sort((a,b)=>a-b); if(arr.length<minPeriods){ rows.push({label,thu,count:arr.length,req:minPeriods,periods:arr.join(', ')}); } } }
  $('#minPeriodDayContainer').innerHTML = rows.length
    ? `<table class="table table-bordered mb-3"><thead class="table-warning"><tr><th>L·ªõp</th><th>Th·ª©</th><th>S·ªë ti·∫øt th·ª±c t·∫ø</th><th>Y√™u c·∫ßu t·ªëi thi·ªÉu</th><th>C√°c ti·∫øt</th></tr></thead><tbody>${
        rows.map(r=>`<tr class="table-warning"><td>${r.label}</td><td>${r.thu}</td><td>${r.count}</td><td>${r.req}</td><td>${r.periods}</td></tr>`).join('')
      }</tbody></table>`
    : `<div class="alert alert-success mb-3">T·∫•t c·∫£ c√°c l·ªõp ƒë·ªÅu c√≥ s·ªë ti·∫øt t·ªëi thi·ªÉu h·ª£p l·ªá trong m·ªói ng√†y!</div>`;
}
function renderConsecutivePeriodsTable(){
  const tbody=$('#tkbTable')?.tBodies?.[0]; if(!tbody) return;
  const { classLabels } = getHeaders(); const dayTiet={};
  Array.from(tbody.rows).forEach(tr=>{
    const { thu, tiet } = getThuTiet(tr);
    $$('input[data-role="mon"]', tr).forEach((inp,i)=>{ const label=classLabels[i]; if(label && inp.value.trim()){ (dayTiet[label]??={}); (dayTiet[label][thu]??=[]).push(tiet); }});
  });
  const rows=[]; for(const label of classLabels){ const days=dayTiet[label]||{}; for(const thu in days){ const arr=(days[thu]||[]).filter(n=>n!=='' && !isNaN(n)).sort((a,b)=>a-b); if(arr.length<=1) continue; let ok=true; for(let i=1;i<arr.length;i++){ if(arr[i]-arr[i-1]!==1){ ok=false; break; } } if(!ok) rows.push({label,thu,periods:arr.join(', '),note:'C√°c ti·∫øt kh√¥ng li·ªÅn nhau (x√© l·∫ª)!'}); } }
  $('#consecutivePeriodsContainer').innerHTML = rows.length
    ? `<table class="table table-bordered mb-3"><thead class="table-warning"><tr><th>L·ªõp</th><th>Th·ª©</th><th>C√°c ti·∫øt</th><th>Th√¥ng b√°o</th></tr></thead><tbody>${
        rows.map(r=>`<tr class="table-warning"><td>${r.label}</td><td>${r.thu}</td><td>${r.periods}</td><td>${r.note}</td></tr>`).join('')
      }</tbody></table>`
    : `<div class="alert alert-success mb-3">Kh√¥ng c√≥ l·ªõp n√†o b·ªã x√© l·∫ª ti·∫øt trong ng√†y!</div>`;
}
function renderAllReports(){ renderDuplicateTable(); const v=parseInt($('#min_period_input')?.value||'2',10)||2; renderMinPeriodPerDayTable(v); renderConsecutivePeriodsTable(); }

/* ========= Kh·ªüi t·∫°o ========= */
window.addEventListener('DOMContentLoaded', ()=>{
  {% if headers %}
    initAutosave();
    renderAllReports();
    $('#min_period_input')?.addEventListener('input', debounce(()=> renderMinPeriodPerDayTable(parseInt($('#min_period_input').value||'2',10)||2), 120));
  {% endif %}
});
</script>
{% endblock %}
